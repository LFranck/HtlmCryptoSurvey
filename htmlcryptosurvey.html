<html>
    <head>
        <title>Cours en temps réel (Prototype)</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta http-equiv = "pragma"content ="no-cache" >
        <META http-equiv="expires" content="-1">
        <style type="text/css">  
            div#bitcoin, div#lowcadre, div#highcadre, div#lowcadreavg, div#highcadreavg {
                margin: 5px;
                padding: 5px;
                font-size: 25px;
                line-height: 30px;
                min-height:60px;
                font-weight: bold;
                border:1px solid #ccc;
                border-radius:5px;
                width:300px;
                margin-left:auto;
                margin-right:auto;
                padding-top:0px;
                text-align: center;
                position: relative;
            }
            div#horo {
                right:5px;
                bottom:-21px;
                font-size: 12px;
            }
            div#source {
                font-size:12px;
                color:#999;
                position:fixed;
                bottom:5px;
                right:5px;
            }
            div#info {
                background-color:#eee;
                min-height: 10px;
                padding:5px;
                margin:10px;
                font-size: 15px;
            } 
        </style>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            function drawChart(values, options) {
                var data = google.visualization.arrayToDataTable(values);
                var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
                chart.draw(data, options);
            }
        </script>
        <script type="text/javascript" src="fonctions.js"></script>
        <script type="text/javascript">
            // Paramètres
            var exchange = "kraken";
            var currency = "EUR";
            var coin = "XLM";
            var limitPourcent = 0.30;
            var urlDay, urlPrice, urlHour;

            // Gestion interval
            var refreshUrlPrice, refreshUrlHour, refreshUrlDay;

            //var url = constructUrl("histoday", "limit=700");
            //var url = constructUrl("histoday", "allData=true");
            //var urlPrice = contructUrl("price", "allData=true");
            //https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=GBP&limit=10
            //var urlExchangeList = "https://min-api.cryptocompare.com/data/exchange/list";




            // GetCours
            var jsonBlochainList = [];
            var jsonCours = [];
            var jsonprevious = [];
            var jsonDays = [];
            var jsonHours = [];
            var nbjr = 2;
            var affi = 15;
            var previousValue = 0;
            var previousHigh = 0, previousLow = 0;
            var currentHigh = 0, currentLow = 0;
            var valuesLow = [];
            var valuesHigh = [];


            /**
             * 
             * @param {type} entry
             * @param {type} nbJrs
             * @returns {undefined}
             */
            function calcul(localdays, moyLow, moyHigh, usd, start, nbCritere) {
                let timestart = new Date(start);
                //console.log(timestart.getTime());
                document.getElementById("info").innerHTML = ""; // vidage de l'info
                if (usd == 0)
                    return;
                var usdstart = usd;
                var btc = 0;
                var nbOp = 0;

                var message = "";
                for (var i = 0; i < localdays.length - 1; i++) {
                    if (localdays[i].time < timestart.getTime() / 1000)
                        continue;
                    if (btc == 0 && (moyLow[i] > localdays[i].low) && (moyLow[i + 1] < localdays[i + 1].low)) {
                        var localCritere = 1;
                        if (localdays[i].high < localdays[i + 1].high)
                            localCritere++;
                        var limite = limitPourcent * (localdays[i].high - localdays[i].low) + localdays[i].low;
                        if (localdays[i].close < limite)
                            localCritere++;
                        if (localCritere == nbCritere) {
                            btc = usd / localdays[i].close;
                            message += "Le " + formatDate(localdays[i].time) + "\tAchat à " + formatMontant(localdays[i].low) + "\t-> " + formatCoin(btc);
                            usd = 0;
                            nbOp++;
                        }
                    } else if (usd == 0 && (moyHigh[i] < localdays[i].high) && (moyHigh[i + 1] > localdays[i + 1].high)) {
                        var localCritere = 1;
                        if (localdays[i].low > localdays[i + 1].low)
                            localCritere++;
                        var limite = (1 - limitPourcent) * (localdays[i].high - localdays[i].low) + localdays[i].low;
                        if (localdays[i].close > limite)
                            localCritere++;
                        if (localCritere = nbCritere) {
                            usd = btc * localdays[i].close;
                            message += "Le " + formatDate(localdays[i].time) + "\tVente à " + formatMontant(localdays[i].high) + "\t-> " + formatMontant(usd);
                            btc = 0;
                            nbOp++;
                        }
                    }
                    if (message != "") {
                        //console.log(message);
                        document.getElementById("info").innerHTML += "<br />" + message;
                    }
                    message = "";
                }
                var total = (btc == 0) ? usd : btc * localdays[localdays.length - 1].high;
                var currnbjrs = Math.round((Date.now() - timestart) / 1000 / 3600 / 24);
                var moyjrs = Math.round(currnbjrs / nbOp) + 1;
                var pourcent = Math.exp(Math.log(total / usdstart) / (nbOp - 1)) - 1;
                total = formatMontant(total);
                document.getElementById("result").innerHTML = total;
                pourcent = Math.round(10000 * pourcent) / 100;
                document.getElementById("info").innerHTML += "<br /><br />Résultat " + total + " en "
                        + nbOp + " opérations en " + currnbjrs + " jours soit tous les "
                        + moyjrs + " jours et " + pourcent + " % de gains en moyenne.";
            }

            /**
             * Récupère la liste des coins pour les mettre dans le select
             * @param {type} url
             * @returns {undefined}
             */
            function getBlockchain() {
                console.log("getBlockchain");
                var url = "https://min-api.cryptocompare.com/data/blockchain/list";
                var ajax = new XMLHttpRequest();
                ajax.onload = function () {
                    console.log("getBlockchain -> " + this.status);
                    if (this.status == 200) {
                        try {
                            var json = JSON.parse(this.response);
                            console.log(json);
                            if (json.Response == "Error")
                                return false;
                            var datas = json.Data;
                            select = document.getElementById('blockchain');
                            select.appendChild(opt);
                            for (var i = 0; i <= datas.length; i++) {
                                console.log(datas[i].symbol);
                                var opt = document.createElement('option');
                                opt.value = datas[i].symbol;
                                opt.innerHTML = datas[i].symbol;
                                select.appendChild(opt);
                            }
                        } catch (err) {
                            console.log("getJson " + url + " : Retour JSON incorrect -> " + err);
                            return false;
                        }
                    }
                }
                ajax.ontimeout = function () {
                    console.log("getJson : Le service n'a pas répondu à temps : nouvel essai dans 5 sec");
                    setTimeout(function () {
                        getBlockchain(url, ret);
                    }, 5000);
                }
                ajax.open("GET", url, true);
                ajax.timeout = 1000;
                ajax.send();
            }

            /**
             * 
             * @returns {undefined}
             */
            function getHisto(url) {
                /* Appel AJAX vers cryptocompare.com */
                var ajax = new XMLHttpRequest();
                console.log("getHisto : readyState après new : " + ajax.readyState);
                /* Détection de l'avancement de l'appel */
                ajax.onreadystatechange = function () {
                    //console.log("getHisto : readyState a changé et vaut : " + ajax.readyState)
                }
                /* Détection de la fin de l'appel */
                ajax.onload = function () {
                    var lastDate;
                    //console.log("getCours : Appel AJAX terminé");
                    //console.log("  status : " + this.status);
                    //console.log("  response : " + this.response);
                    //console.log("  response : " + this.response);
                    if (this.status == 200) {
                        /* Le service a bien répondu */
                        try {
                            // Enregistrement des valeurs
                            JSON.parse(this.response, (key, currentValue) => {
                                //console.log(key);
                                switch (key) {
                                    case 'high':
                                        valuesHigh.push(currentValue);
                                        break;
                                    case 'low':
                                        valuesLow.push(currentValue);
                                        break;
                                    case 'time':
                                        lastDate = currentValue;
                                        break;
                                    default:
                                        break;
                                }
                            });
                            console.log("lecture ->" + valuesLow.length + " " + valuesHigh.length + " last date=" + timeConverter(lastDate));
                        } catch (err) {
                            console.log("Get Histo : Retour JSON incorrect " + err);
                            return false;
                        }
                    }
                }
                /* Détection du timeout */
                ajax.ontimeout = function () {
                    console.log("getHisto Le service n'a pas répondu à temps : nouvel essai dans 5 sec");
                    /* Relancer l'appel 5 secondes plus tard */
                    setTimeout("getHisto()", 5000);
                }
                /* Préparation de la requête et envoi */
                ajax.open("GET", url, true);
                ajax.timeout = 1000;
                /* Délai d'expiration à 1 seconde */
                ajax.send();
            }

            /**
             * Récupération des données de cours du Bitcoin en temps réel
             * @returns {undefined}
             */
            function getCours(url) {
                /* Appel AJAX vers cryptocompare.com */
                var ajax = new XMLHttpRequest();
                console.log("getCours : readyState après new : " + ajax.readyState);
                /* Détection de l'avancement de l'appel */
                ajax.onreadystatechange = function () {
                    //console.log("getCours : readyState a changé et vaut : " + ajax.readyState)
                }
                /* Détection de la fin de l'appel */
                ajax.onload = function () {
                    //console.log("getCours : Appel AJAX terminé");
                    //console.log("  status : " + this.status);
                    //console.log("  response : " + this.response);
                    if (this.status == 200) {
                        /* Le service a bien répondu */
                        try {
                            if (jsonCours != null) {
                                console.log("getCours : Enregistrement du json dans previous");
                                jsonPrevious = jsonCours;
                            }
                            jsonCours = JSON.parse(this.response);
                        } catch (err) {
                            console.log("getCours : Retour JSON incorrect");
                            return false;
                        }
                        setAffichage();
                    }
                }
                /* Détection du timeout */
                ajax.ontimeout = function () {
                    console.log("getCours : Le service n'a pas répondu à temps : nouvel essai dans 5 sec");
                    /* Relancer l'appel 5 secondes plus tard */
                    setTimeout("getCours()", 5000);
                }
                /* Préparation de la requête et envoi */
                ajax.open("GET", url, true);
                ajax.timeout = 1000;
                /* Délai d'expiration à 1 seconde */
                ajax.send();
            }

            /**
             * 
             * @returns {undefined}
             */
            function getDays() {
                /*
                 * Traitement
                 * @type String
                 */
                //console.log("getDays");
                //console.log(jsonHours);
                if (jsonDays.length == 0)
                    return;
                //console.log(jsonDays[jsonDays.length - 1]);

                // Parcours les données des dernières heures pour compléter le tableau               
                var highToday = 0;
                var lowToday = 0;
                //console.log(jsonDays);
                //console.log(jsonHours);
                for (var i = 0; i < jsonHours.length; i++) {
                    if (jsonHours[i].time > jsonDays[jsonDays.length - 1].time) {
                        if (highToday == 0 || highToday < jsonHours[i].high)
                            highToday = jsonHours[i].high;
                        if (lowToday == 0 || lowToday > jsonHours[i].low)
                            lowToday = jsonHours[i].low;
                    }
                }

                //console.log(lowToday + " < " + highToday);
                //console.log(highToday);
                //console.log(lowToday);

                var localDays = JSON.parse(JSON.stringify(jsonDays));
                /*
                 var myObj = {
                 "time": Date.now() / 1000,
                 "low": lowToday, //your artist variable
                 "high": highToday   //your title variable
                 };
                 localDays.push(myObj);
                 */

                //console.log("getDays : " + jsonDays[jsonDays.length - 2].high + " -> " + jsonDays[jsonDays.length - 1].high);
                //console.log("getDays : " + localDays[localDays.length - 2].high + " -> " + localDays[localDays.length - 1].high);

                var moyHigh = [], moyLow = [];
                for (var i = 0; i < localDays.length; i++) {
                    moyHigh[i] = 0;
                    moyLow[i] = 0;
                }
                for (var k = 0; k < localDays.length; k++) {
                    var cumulHigh = 0, cumulLow = 0;
                    for (var l = k; l < k + nbjr; l++) {
                        if (l < localDays.length) {
                            cumulHigh += localDays[l].high;
                            cumulLow += localDays[l].low;
                        }
                    }
                    if (l - 1 < localDays.length) {
                        moyHigh[l - 1] = cumulHigh / nbjr;
                        moyLow[l - 1] = cumulLow / nbjr;
                    }
                }

                var sommedepart = document.getElementById("sommedepart").value;
                var tripstart = document.getElementById("tripstart").value;
                var nbcriteres = tripstart = document.getElementById("nbcriteres").value;
                calcul(localDays, moyLow, moyHigh, sommedepart, tripstart, nbcriteres);
                affichageTexte("lowcadre", "low", localDays[localDays.length - 2].low, localDays[localDays.length - 1].low, formatDate(localDays[localDays.length - 2].time));
                affichageTexte("highcadre", "high", localDays[localDays.length - 2].high, localDays[localDays.length - 1].high, formatDate(localDays[localDays.length - 2].time));
                affichageTexte("lowcadreavg", "lowavg", moyLow[moyLow.length - 2], moyLow[moyLow.length - 1], formatDate(localDays[localDays.length - 2].time));
                affichageTexte("highcadreavg", "highavg", moyHigh[moyHigh.length - 2], moyHigh[moyHigh.length - 1], formatDate(localDays[localDays.length - 2].time));

                var inputs = [];
                var colons = []
                colons.push('Date');
                colons.push('Low');
                colons.push({role: 'annotation'});
                colons.push('High');
                colons.push({role: 'annotation'});
                colons.push('Moy Low');
                colons.push('Moy High');
                colons.push('Now');
                var lastAchat = 0;
                var lastVente = 0;
                for (var i = localDays.length - affi * 2; i < localDays.length; i++) {
                    if (inputs.length == affi)
                        inputs.shift();
                    var a1 = undefined, a2 = undefined;
                    var ligne = [];

                    if ((i < localDays.length - 1) && (localDays[i].low < moyLow[i]) && (localDays[i + 1].low > moyLow[i + 1])) {
                        var current = (lastVente == 0) ? 0 : Math.round(10 * (100 - 100 * localDays[i].low / lastVente)) / 10;
                        lastAchat = localDays[i].low;
                        a1 = "achat (" + current + "%) +";
                        if (localDays[i].high < localDays[i + 1].high) {
                            a1 = a1 + "+";
                        } else {
                            a1 = a1 + "-";
                        }
                        var limite = limitPourcent * (localDays[i].high - localDays[i].low) + localDays[i].low;
                        if (localDays[i].close < limite) {
                            a1 = a1 + "+";
                        } else {
                            a1 = a1 + "-";
                        }
                        if (i == localDays.length - 1)
                            notifyMe("Achat interressant !!!")
                    }
                    if ((i < localDays.length - 1) && (localDays[i].high > moyHigh[i]) && (localDays[i + 1].high < moyHigh[i + 1])) {
                        var current = (lastAchat == 0) ? 0 : Math.round(10 * (100 * localDays[i].high / lastAchat - 100)) / 10;
                        lastVente = localDays[i].high;
                        a2 = "vente (" + current + "%) +";
                        if (localDays[i].low < localDays[i + 1].low) {
                            a2 = a2 + "-";
                        } else {
                            a2 = a2 + "+";
                        }
                        var limite = (1 - limitPourcent) * (localDays[i].high - localDays[i].low) + localDays[i].low;
                        if (localDays[i].close > limite) {
                            a2 = a2 + "+";
                        } else {
                            a2 = a2 + "-";
                        }
                        if (i == localDays.length - 1)
                            notifyMe("Vente interressante !!!")
                    }

                    ligne.push(timeConverter(localDays[i].time, false));
                    ligne.push(localDays[i].low);
                    ligne.push(a1);
                    ligne.push(localDays[i].high);
                    ligne.push(a2);
                    ligne.push(moyLow[i]);
                    ligne.push(moyHigh[i]);
                    ligne.push(jsonCours[jsonCours.length - 1].close);
                    inputs.push(ligne);
                }
                // Rajoute les entêtes
                inputs.unshift(colons);

                var options = {
                    title: 'Les courbes',
                    //curveType: 'function',
                    lineWidth: 1,
                    legend: {position: 'bottom'},
                    hAxis: {title: 'Date'},
                    vAxis: {title: 'Values'},
                    annotations: {
                        boxStyle: {
                            // Color of the box outline.
                            stroke: '#888',
                            // Thickness of the box outline.
                            strokeWidth: 1,
                            // x-radius of the corner curvature.
                            rx: 10,
                            // y-radius of the corner curvature.
                            ry: 10,
                            // Attributes for linear gradient fill.
                            gradient: {
                                // Start color for gradient.
                                color1: '#fbf6a7',
                                // Finish color for gradient.
                                color2: '#33b679',
                                // Where on the boundary to start and
                                // end the color1/color2 gradient,
                                // relative to the upper left corner
                                // of the boundary.
                                x1: '0%', y1: '0%',
                                x2: '100%', y2: '100%',
                                // If true, the boundary for x1,
                                // y1, x2, and y2 is the box. If
                                // false, it's the entire chart.
                                useObjectBoundingBoxUnits: true
                            }
                        }
                    }
                };
                google.charts.load('current', {'packages': ['corechart']});
                google.charts.setOnLoadCallback(function () {
                    drawChart(inputs, options);
                });
            }

            /**
             * 
             * @returns {undefined}
             */
            function setAffichage() {
                //console.log("setAffichage");
                getDays();
                if (jsonCours == null) {
                    return;
                }
                if (jsonCours.length == 0) {
                    return;
                }

                var inPrevious = jsonCours[0].close;
                var inCurrent = jsonCours[jsonCours.length - 1].close;
                // Afficher
                affichageTexte("bitcoin", "cours", inPrevious, inCurrent, hourConverter(jsonCours[0].time));
                document.querySelector("div#horo").innerHTML = "MàJ " + timeConverter(jsonCours[jsonCours.length - 1].time, true);
                document.getElementById("statresult").style.visibility = "visible";
                document.getElementById("bg_mask").style.visibility = "hidden";
            }

            /**
             * Mets à jours les tableaux contenants les valeurs
             * @returns {undefined}
             */
            function toDo() {
                document.getElementById("statresult").style.visibility = "hidden";
                document.getElementById("bg_mask").style.visibility = "visible";

                // Annulation des elements précédent
                clearInterval(refreshUrlPrice);
                clearInterval(refreshUrlHour);
                clearInterval(refreshUrlDay);
                jsonCours = [];
                jsonHours = [];
                jsonDays = [];

                // Le cours chaque minutes
                urlPrice = constructUrl("histominute", "limit=10");
                //console.log("urlPrice = " + urlPrice);
                getJson(urlPrice, jsonCours);
                refreshUrlPrice = setInterval(function () {
                    getJson(urlPrice, jsonCours);
                }, 30000);

                // Le cours des derniers jours
                urlHour = constructUrl("histohour", "limit=24")
                //console.log("urlHour = " + urlHour);
                getJson(urlHour, jsonHours);
                refreshUrlHour = setInterval(function () {
                    getJson(urlHour, jsonHours);
                }, 30000);

                // Le cours des derniers jours
                urlDay = constructUrl("histoday", "allData=true");
                //console.log("urlDay = " + urlDay);
                getJson(urlDay, jsonDays);
                refreshUrlDay = setInterval(function () {
                    getJson(urlDay, jsonDays);
                }, 30000);

                setAffichage();
                setInterval("setAffichage()", 10000);
            }

            window.onload = function () {
                // Initialisation du select des coins
                //getJson("https://min-api.cryptocompare.com/data/blockchain/list?api_key=1a01edc67d71cef22b5f25b5b439fb9d512a339d7ac223f02d93d34dc3635a32", testjson);
                // Tâches à faire
                toDo();
            }


        </script>
    </head>
    <body>
        <table width="100%">
            <tr><th align="left">Choix statistiques</th><th align="left">Paramètres</th></tr>
            <tr><td>
                    <select id="sbitcoin" onChange="coin = this.value;
                            toDo();" size="5">
                        <option value="BTC">Bitcoin</option>
                        <option value="ETH">Ethereum</option>
                        <option value="USDT">Tehter USD</option>
                        <option value="XRP">Ripple</option>
                        <option value="BCH">Bitcoin Cash</option>
                        <option value="LINK">Chain Link</option>
                        <option value="XLM">Lumen</option>
                        <option value="XMR">Monero</option>
                        <option value="DASH">Dash</option>
                        <option value="BAT">BAT</option>
                    </select> 
                    <select id="scurrency" onChange="currency = this.value;
                            toDo();" size="5">
                        <option value="USD">USD</option>
                        <option value="EUR" selected>EUR</option>
                    </select> 
                    <select id="sexchange" onChange="exchange = this.value;
                            toDo();" size="5">
                        <option value="kraken" selected>Kraken</option>
                        <option value="binance">Binance</option>
                        <option value="coinbase">Coinbase</option>
                        <option value="gemini">Gemini</option>
                    </select> 
                </td>
                <td>
                    <br />Moyenne sur <input type="number" min="2" max="20" id="snbjr" value="4" size="1" onChange="nbjr = parseInt(this.value);
                            toDo();"> jours
                    <br />Affichage historique sur <input type="number" min="5" id="saff" value="15" onChange="affi = parseInt(this.value);
                            if (affi < 1)
                                alert('Ni nul ni négatif !!');
                            else
                                toDo();" size="1"> jours
                </td>
            </tr>
        </table>
        <div id="bg_mask" style="background-position:50px 50px; height:0px; width:0px; visibility:visible"><img src="loading.gif" /></div>
        <div id="statresult" style="hidden">
            <table>
                <tr><th align="left">Paramètres simulation</th><th align="left">Résultat</th></tr>
                <tr>
                    <td>Somme de départ <input type="number" id="sommedepart" name="sommedepart" min="1" max="100" size="1">
                        <br/>Date de Départ <input type="date" id="tripstart" name="tripstart" value="2018-07-22" min="2010-01-01" max="2021-12-31">
                        <br/>Nb critères <input type="number" id="nbcriteres" name="nbcriteres" min="1" max="3" size="1" value="3">
                        <br/>Pourcentage pour le 3eme critère : <script type="text/javascript">document.write(100 * limitPourcent+ "%"); </script>
                    </td>
                    <td><div id="resultcadre"><div id="result">Attendez</div></div></td>
                </tr>
            </table>
            <h2 id="monH1">Cours en temps réel</h2>
            <table>
                <tr><th>Low</th><th>Cours</th><th>High</th></tr>
                <tr>
                    <td>
                        <div id="lowcadre"><div id="low"></div></div>
                        <div id="lowcadreavg"><div id="lowavg"></div></div>
                    </td>
                    <td>
                        <div id="bitcoin"><div id="cours"></div></div>
                <center><div id="horo"></div></center>
                </td>
                <td>
                    <div id="highcadre"><div id="high"></div></div>
                    <div id="highcadreavg"><div id="highavg"></div></div>
                </td>
                </tr>
                <tr><th>Low Average</th><th></th><th>High Average</th></tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr><td colspan="3"></td></tr>
            </table>
            <div id="curve_chart" style="width: 1200px; height: 600px;align-items: center;"></div>
            <div id="info"></div>
        </div>
        <div id="source">2020©LFRANCK - Cours provenant de l'API cryptocompare.com - Version 0.9.25 27/10/2020</div>
    </body>
</html>
